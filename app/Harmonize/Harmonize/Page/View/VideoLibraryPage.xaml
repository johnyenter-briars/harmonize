<?xml version="1.0" encoding="utf-8" ?>
<pages:BasePage 
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:Harmonize.Page.View"
             xmlns:pages="clr-namespace:Harmonize.Page"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewModels="clr-namespace:Harmonize.ViewModel"
             x:TypeArguments="viewModels:VideoLibraryViewModel"
             x:DataType="viewModels:VideoLibraryViewModel"
             x:Class="Harmonize.Page.View.VideoLibraryPage"
             xmlns:model="clr-namespace:Harmonize.Model"
             xmlns:harmonizeModel="clr-namespace:Harmonize.Client.Model.Media;assembly=Harmonize.Client"
             xmlns:components="clr-namespace:Harmonize.Components"
             Title="Video Library">

    <Shell.TitleView>
        <HorizontalStackLayout
        Padding="10,0"
        Spacing="16"
        HorizontalOptions="Start"
        VerticalOptions="Center">

            <Label
            Text="Video Library"
            FontSize="20"
            VerticalTextAlignment="Center"
            HorizontalOptions="Start"
            TextColor="{StaticResource OffWhite}" />

            <ImageButton
            Source="icons8_slider_48.png"
            Scale="0.6"
            BackgroundColor="Transparent"
            VerticalOptions="Center"
            Clicked="OnFilterClicked">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior
                    TintColor="{StaticResource SecondaryDarkText}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <ImageButton
            Source="icons8_search_50.png"
            Scale="0.6"
            BackgroundColor="Transparent"
            VerticalOptions="Center"
            Command="{Binding OpenSearchCommand}"
            CommandParameter="{x:Reference searchBar}"
            Clicked="ScaleButton">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior
                    TintColor="{StaticResource SecondaryDarkText}" />
                </ImageButton.Behaviors>
            </ImageButton>

        </HorizontalStackLayout>
    </Shell.TitleView>


    <Grid Padding="10"
          RowDefinitions="Auto,*"
          BackgroundColor="{StaticResource Gray900}">

        <Border
            Grid.Row="0"
            BackgroundColor="{StaticResource Gray900}"
            Stroke="DarkGray"
            StrokeThickness="1"
            Padding="5"
            Margin="0,0,0,10"
            IsVisible="{Binding SearchBarVisible}">

            <Border.StrokeShape>
                <RoundRectangle CornerRadius="10"/>
            </Border.StrokeShape>

            <SearchBar
                x:Name="searchBar"
                Placeholder="Search..."
                Text="{Binding SearchQuery}"
                SearchCommand="{Binding SearchCommand}"
                SearchCommandParameter="{Binding ., Source={x:Reference searchBar}}"
                FontSize="18"
                HeightRequest="40"
                TextColor="{StaticResource OffWhite}"
                BackgroundColor="{StaticResource Gray900}" />
        </Border>

        <RefreshView
            Grid.Row="1"
            IsRefreshing="{Binding FetchingData}"
            Command="{Binding RefreshCommand}"
            BackgroundColor="{StaticResource Gray900}">

            <CollectionView
                ItemsSource="{Binding MediaEntries}"
                SelectionMode="Single"
                RemainingItemsThreshold="1"
                RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}"
                VerticalOptions="FillAndExpand"
                HorizontalOptions="FillAndExpand"
                BackgroundColor="{StaticResource Gray900}"
                >

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="harmonizeModel:MediaEntry">
                        <components:ListElement
                            BackgroundColor="{StaticResource Gray900}"
                            Opacity="1">

                            <Grid
                                ColumnDefinitions="*,Auto"
                                Padding="8"
                                VerticalOptions="Center">

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:VideoLibraryViewModel}}, Path=ItemTappedCommand}"
                                        CommandParameter="{Binding .}"
                                        Tapped="TapGestureRecognizer_Tapped" />
                                </Grid.GestureRecognizers>

                                <Label
                                    Grid.Column="0"
                                    Text="{Binding Name}"
                                    FontSize="14"
                                    VerticalOptions="Center"
                                    TextColor="{StaticResource OffWhite}" />

                                <Grid Grid.Column="1"
                                      ColumnDefinitions="Auto,Auto"
                                      VerticalOptions="Center">

                                    <Button
                                        Text="⋮"
                                        FontSize="18"
                                        Scale="1.5"
                                        BackgroundColor="Transparent"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:VideoLibraryViewModel}}, Path=OpenBottomSheetCommand}"
                                        CommandParameter="{Binding .}"
                                        Clicked="OnOpenBottomSheetClicked" />

                                    <Image
                                        Grid.Column="1"
                                        Source="icons8_cloud_download_66.png"
                                        WidthRequest="15"
                                        HeightRequest="15"
                                        IsVisible="{Binding Transferred}">
                                        <Image.Behaviors>
                                            <toolkit:IconTintColorBehavior TintColor="{StaticResource PrimaryDark}" />
                                        </Image.Behaviors>
                                    </Image>
                                </Grid>
                            </Grid>
                        </components:ListElement>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.Footer>
                    <ActivityIndicator
                        IsRunning="{Binding FetchingData}"
                        Color="{StaticResource Primary}" />
                </CollectionView.Footer>

            </CollectionView>
        </RefreshView>

        <components:BottomMenu x:Name="bottomMenu" IsVisible="False">
            <Border
                BackgroundColor="{StaticResource Gray600}"
                Padding="15"
                VerticalOptions="End"
                AbsoluteLayout.LayoutBounds="0,1,1,AutoSize"
                AbsoluteLayout.LayoutFlags="PositionProportional, WidthProportional"
                >
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="15" />
                </Border.StrokeShape>

                <Grid RowDefinitions="Auto,Auto" RowSpacing="12">

                    <Grid>
                        <Button
                            Text="✕"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Gray300}"
                            FontSize="18"
                            WidthRequest="32"
                            HeightRequest="32"
                            HorizontalOptions="End"
                            VerticalOptions="Start"
                            Padding="0"
                            Margin="0"
                            Clicked="OnOpenBottomSheetClicked" />
                    </Grid>

                    <StackLayout Grid.Row="1" Spacing="12">

                        <Button
                            Text="Toggle Transfer to Media System"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="Black"
                            FontAttributes="Bold"
                            FontSize="16"
                            CornerRadius="12"
                            HeightRequest="48"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:VideoLibraryViewModel}}, Path=ToggleTransferToMediaSystem}"
                            Clicked="OnOpenBottomSheetClicked"
                            />

                        <Button
                            Text="Add to Season"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            FontSize="16"
                            CornerRadius="12"
                            HeightRequest="48"
                            BorderColor="{StaticResource Primary}"
                            BorderWidth="1" 
                            Clicked="OnOpenBottomSheetClicked"
                            />

                    </StackLayout>
                </Grid>
            </Border>
        </components:BottomMenu>

        <components:BottomMenu x:Name="filterMenu" IsVisible="False">
            <Border 
                BackgroundColor="{StaticResource Gray600}"
                Padding="15"
                VerticalOptions="End"
                AbsoluteLayout.LayoutBounds="0, 1, 1, AutoSize"
                AbsoluteLayout.LayoutFlags="PositionProportional, WidthProportional">

                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="15" />
                </Border.StrokeShape>

                <Grid ColumnDefinitions="Auto, Auto"
                    RowDefinitions="Auto, Auto"
                    ColumnSpacing="20"
                    RowSpacing="8">

                    <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="10">
                        <CheckBox 
                            Color="{StaticResource Primary}" 
                            WidthRequest="24" 
                            HeightRequest="24"
                            IsChecked="{Binding FilterByMovie, Mode=TwoWay}" 
                            Margin="5,0,0,0"/>
                        <Label 
                            Text="Movie" 
                            FontSize="16"
                            TextColor="{StaticResource White}" 
                            VerticalOptions="Center"/>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="10">
                        <CheckBox 
                            Color="{StaticResource Primary}" 
                            WidthRequest="24" 
                            HeightRequest="24"
                            IsChecked="{Binding FilterByTransferred, Mode=TwoWay}" 
                            Margin="5,0,0,0"/>
                        <Label 
                            Text="Transferred" 
                            FontSize="16"
                            TextColor="{StaticResource White}" 
                            VerticalOptions="Center"/>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="10">
                        <CheckBox 
                            Color="{StaticResource Primary}" 
                            WidthRequest="24" 
                            HeightRequest="24"
                            IsChecked="{Binding FilterByEpisode, Mode=TwoWay}" 
                            Margin="5,0,0,0"/>
                        <Label 
                            Text="Episode" 
                            FontSize="16"
                            TextColor="{StaticResource White}" 
                            VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                </Grid>
            </Border>
        </components:BottomMenu>
    </Grid>
</pages:BasePage>